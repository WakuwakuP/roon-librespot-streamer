version: "3.8"

services:
  roon-librespot-streamer:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: roon-librespot-streamer
    restart: unless-stopped
    # Required for mDNS (Spotify Connect discovery) - Linux only
    network_mode: host
    environment:
      # Spotify Connect device name (as shown in Spotify)
      - DEVICE_NAME=Spotify Connect (Roon)

      # Audio quality settings
      - BITRATE=320

      # Streaming server settings
      - STREAM_FORMAT=flac
      - STREAMING_PORT=8080
      - SILENCE_ON_NO_INPUT=true # Stream silence when no audio from librespot

      # Volume settings (0-100)
      - INITIAL_VOLUME=100
      - VOLUME_CTRL=linear

      # Internal settings (usually no need to change)
      - FIFO_PATH=/tmp/librespot-audio

      # Additional librespot arguments (optional)
      - LIBRESPOT_ARGS=--disable-credential-cache

      # Cache directory for credentials and audio (important for authentication)
      - CACHE_DIR=/cache
    volumes:
      # Persist Spotify credentials cache (delete this folder to re-authenticate)
      - librespot-cache:/cache
    # Note: ports mapping is not used with network_mode: host
    # The container uses the host's network directly
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  librespot-cache:
