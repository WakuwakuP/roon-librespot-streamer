services:
  librespot-streamer:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: roon-librespot-streamer
    restart: unless-stopped
    
    # Network mode host for mDNS/Spotify Connect discovery
    network_mode: host
    
    # Fix audio key errors by blocking apresolve.spotify.com
    # This forces librespot to use hardcoded API endpoints
    # See: https://github.com/librespot-org/librespot/issues/1649
    extra_hosts:
      - "apresolve.spotify.com:0.0.0.0"
    
    environment:
      # Device configuration
      - DEVICE_NAME=Roon Librespot FLAC Streamer
      - BITRATE=320
      - INITIAL_VOLUME=50
      - VOLUME_CONTROL=linear
      
      # Backend configuration (pipe for FLAC streaming, alsa for direct audio)
      - BACKEND=pipe
      
      # HTTP streaming configuration
      - HTTP_PORT=8080
      - HTTP_BIND_ADDR=0.0.0.0
      
      # Logging configuration (suppress noisy mDNS and Symphonia MP3 demuxer warnings)
      # Options: error, warn, info, debug, trace
      # Module-specific: warn,libmdns=error,symphonia_bundle_mp3=error (default)
      # Symphonia MP3 demuxer warnings are non-fatal and don't affect playback
      - RUST_LOG=warn,libmdns=error,symphonia_bundle_mp3=error
      
      # Optional: Stream metadata for Roon/Icecast compatibility
      # - STREAM_NAME=My Spotify Stream
      # - STREAM_GENRE=Various
      # - STREAM_DESCRIPTION=Spotify streaming via Librespot
      # - STREAM_URL=http://my-server.local:8080
      
      # Optional: Spotify credentials (not recommended, use Spotify Connect instead)
      # - SPOTIFY_USERNAME=your_username
      # - SPOTIFY_PASSWORD=your_password
      
      # Cache configuration
      - CACHE_SIZE_LIMIT=1G
      
      # Optional: Credentials file
      # - CREDENTIALS_FILE=/config/credentials.json
      
      # Optional: Additional arguments
      # - EXTRA_ARGS=--disable-audio-cache
    
    volumes:
      # Persistent cache for better performance
      - librespot-cache:/cache
      
      # Optional: Mount credentials file
      # - ./credentials.json:/config/credentials.json:ro
      
      # Optional: For ALSA backend
      # - /dev/snd:/dev/snd
    
    # Optional: For ALSA backend
    # devices:
    #   - /dev/snd:/dev/snd
    
    # Optional: Capabilities for audio
    # cap_add:
    #   - SYS_NICE

volumes:
  librespot-cache:
    driver: local
